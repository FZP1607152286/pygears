
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>My First Instruction &#8212; PyGears - HW Design: A Functional Approach</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="canonical" href="https://www.pygears.org/riscv/my_first_instruction.html" />
    <link rel="shortcut icon" href="../_static/pygears.ico"/>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="RISC-V Tools Setup" href="setup.html" />
    <link rel="prev" title="RISC-V Blog Series Introduction" href="introduction.html" />
  
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  
  <link rel="alternate" type="application/atom+xml"  href="../blog/atom.xml" title="PyGears">
  
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="my-first-instruction">
<h1>My First Instruction<a class="headerlink" href="#my-first-instruction" title="Permalink to this headline">¶</a></h1>

<script>
 function changeVerbosity(verbosity) {

     document.getElementById("verbosity_value").value = verbosity;
     document.getElementById("verbosity_slider").value = verbosity;

     var a = document.querySelectorAll('[data-verbosity]');

     for (var i in a) if (a.hasOwnProperty(i)) {
         if (a[i].getAttribute('data-verbosity') <= verbosity) {
             a[i].removeAttribute("hidden")
         } else {
             a[i].setAttribute("hidden", "true")
         }
     }
 }
</script>

<form class="slidecontainer">
    <b>Slide to adjust verbosity level&ensp;</b>
    <input type="range" min="1" max="2" value="1" name="verbositySlider" id="verbosity_slider" onchange="changeVerbosity(this.value);">
    &ensp;
    <input type="number" maxlength="1" id="verbosity_value" min="1" max="2" value="1" oninput="changeVerbosity(this.value);" style="font-weight: bold"/>
</form>
<p><span data-verbosity="2" hidden="true"> First instruction is probably going to be unlike any other in the amount of work that I’ll need to put into implementing it, so it deserves a post on its own. </span><span> Let’s start from the RV32I description in the (currently) latest version of the </span><a class="reference external" href="https://content.riscv.org/wp-content/uploads/2017/05/riscv-spec-v2.2.pdf">RISC-V ISA Specification</a><span>, which is given in the </span><a class="reference external" href="https://content.riscv.org/wp-content/uploads/2017/05/riscv-spec-v2.2.pdf#page=21">Chapter 2: RV32I Base Integer Instruction Set</a><span>. The specification first goes on to describe </span><a class="reference external" href="https://content.riscv.org/wp-content/uploads/2017/05/riscv-spec-v2.2.pdf#page=25">Integer Computational Instructions (Chapter 2.4)</a><span>, of which the </span><code class="docutils literal notranslate"><span class="pre">addi</span></code><span> instruction is explained first, so let’s start with that one.</span></p>
<p>All RV32I instructions are encoded with 32 bits using several formats (although there is also a <a class="reference external" href="https://content.riscv.org/wp-content/uploads/2017/05/riscv-spec-v2.2.pdf#page=81">Compressed Instruction Formats (Chapter 12.2)</a> but I’ll leave that for later). All the information needed for the instruction execution have to be encoded in 32 bits and formats specify where exactly is each peace of information located within these 32 bits. Usually the instruction needs to specify which operation to perform, which registers are involved (<code class="docutils literal notranslate"><span class="pre">rs</span></code> - register source or <code class="docutils literal notranslate"><span class="pre">rd</span></code> - register destination), and usually provides some immediate values as arguments (<code class="docutils literal notranslate"><span class="pre">imm</span></code> fields). One of the key advantages of the RISC-V ISA is that peaces of information of the same type (like <code class="docutils literal notranslate"><span class="pre">rd</span></code> field) are usually located at the same position within the 32 bit encoding for different formats, which proved to simplify the hardware implementation.</p>
<p>For RV32I, a set of 32 registers is needed, named <code class="docutils literal notranslate"><span class="pre">x0</span></code> - <code class="docutils literal notranslate"><span class="pre">x31</span></code>, where <code class="docutils literal notranslate"><span class="pre">x0</span></code> is different from the others in that it has a fixed value of 0, i.e it’s value cannot be changed. The ISA specification defines the <code class="docutils literal notranslate"><span class="pre">XLEN</span></code> parameter to represent the width of the registers in number of bits: either 32 or 64. I’ll try to keep <code class="docutils literal notranslate"><span class="pre">XLEN</span></code> a design parameter of the processor implementation, but I’ll first focus on a version with <code class="docutils literal notranslate"><span class="pre">XLEN=32</span></code>, i.e with the processor version with 32 bit wide registers.</p>
<div class="section" id="instruction-format">
<h2>Instruction format<a class="headerlink" href="#instruction-format" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">addi</span></code> instruction has an “Integer Register-Immediate” format, aka the “I-type” format shown on the image below. The instruction is executed by adding the value of the 12 bit immediate field <code class="docutils literal notranslate"><span class="pre">imm</span></code> to the value read from the register specified by the <code class="docutils literal notranslate"><span class="pre">rs1</span></code> field. The result is then truncated to <code class="docutils literal notranslate"><span class="pre">XLEN</span></code> bits and stored into the register specified by the <code class="docutils literal notranslate"><span class="pre">rd</span></code> field.</p>
<div class="figure align-center" id="id1">
<img alt="../_images/integer-register-immediate-instruction.png" src="../_images/integer-register-immediate-instruction.png" />
<p class="caption"><span class="caption-text">“Integer Register-Immediate” instruction format, aka the “I-type” format, from the <a class="reference external" href="https://content.riscv.org/wp-content/uploads/2017/05/riscv-spec-v2.2.pdf">RISC-V ISA Specification</a></span></p>
</div>
<p>Since the instruction encodings have fields that serve different purposes from one another, I’ll represent the instruction with the <a class="reference external" href="https://www.pygears.org/typing/tuple.html" title="(in PyGears v0.1.1)"><code class="docutils literal notranslate"><span class="pre">Tuple</span></code></a> PyGears type. The <a class="reference external" href="https://www.pygears.org/typing/tuple.html" title="(in PyGears v0.1.1)"><code class="docutils literal notranslate"><span class="pre">Tuple</span></code></a> type represents a generic heterogenous container type akin to records and structs in other HDLs. For the “I-type” instructions, I have a following definition in PyGears:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">TInstructionI</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">[{</span>
    <span class="s1">&#39;opcode&#39;</span><span class="p">:</span> <span class="n">Uint</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span>
    <span class="s1">&#39;rd&#39;</span>    <span class="p">:</span> <span class="n">Uint</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
    <span class="s1">&#39;funct3&#39;</span><span class="p">:</span> <span class="n">Uint</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
    <span class="s1">&#39;rs1&#39;</span>   <span class="p">:</span> <span class="n">Uint</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
    <span class="s1">&#39;imm&#39;</span>   <span class="p">:</span> <span class="n">Int</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span>
<span class="p">}]</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">opcode</span></code> and <code class="docutils literal notranslate"><span class="pre">funct3</span></code> fields determine the function to be executed, and <code class="docutils literal notranslate"><span class="pre">rd</span></code>, <code class="docutils literal notranslate"><span class="pre">rs1</span></code> and <code class="docutils literal notranslate"><span class="pre">imm</span></code> fields carry the function arguments. Hence in <code class="docutils literal notranslate"><span class="pre">opcode</span></code> and <code class="docutils literal notranslate"><span class="pre">funct3</span></code> fields the ID of the function is stored, so I can represent it with an unsigned number <code class="xref any docutils literal notranslate"><span class="pre">typing/uint</span></code>. Some enumerated type might constrain this fields better, since not all function IDs might be available in a specific processor implementation (after this blog post I will have implemented only one function - <code class="docutils literal notranslate"><span class="pre">addi</span></code>). However, PyGears does not yet support enumerated types, so I’ll use the <code class="xref any docutils literal notranslate"><span class="pre">Uint[N]</span></code> type as the second best.</p>
<p>Values of the <code class="docutils literal notranslate"><span class="pre">rs1</span></code> and <code class="docutils literal notranslate"><span class="pre">rd</span></code> fields contain the IDs of the registers involved, hence they are 5 bit wide so that they can encode all 32 register IDs. The values in the <code class="docutils literal notranslate"><span class="pre">imm</span></code> field are encoded as signed integers. As</p>
<p>I had to consult <a class="reference external" href="https://content.riscv.org/wp-content/uploads/2017/05/riscv-spec-v2.2.pdf#page=115">Chapter 19: RV32/64G Instruction Set Listings</a> in order to get the correct values of the <code class="docutils literal notranslate"><span class="pre">opcode=0x13</span></code> and <code class="docutils literal notranslate"><span class="pre">funct3=0x0</span></code> instruction fields for the <code class="docutils literal notranslate"><span class="pre">addi</span></code>.</p>
<div class="figure align-center" id="id2">
<img alt="../_images/addi-instruction-field-value.png" src="../_images/addi-instruction-field-value.png" />
<p class="caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">addi</span></code> instruction format, from <a class="reference external" href="https://content.riscv.org/wp-content/uploads/2017/05/riscv-spec-v2.2.pdf">RISC-V ISA Specification</a></span></p>
</div>
<div class="figure align-center" id="id3">
<img alt="../_images/addi-timelapse.gif" src="../_images/addi-timelapse.gif" />
<p class="caption"><span class="caption-text"><code class="docutils literal notranslate"><span class="pre">addi</span></code> instruction simulation timelapse. Each frame is a single delta cycle.</span></p>
</div>
<p>I had to consult <a class="reference external" href="https://content.riscv.org/wp-content/uploads/2017/05/riscv-spec-v2.2.pdf#page=121">Chapter 20</a> in order to find the mapping from the <code class="docutils literal notranslate"><span class="pre">x*</span></code> register names to their <a class="reference external" href="https://en.wikipedia.org/wiki/Application_binary_interface">ABI</a> equivalents which are used by the Spike simulator. This chapter also gives examples of the assembly syntaxes for the instructions. Also <a class="reference external" href="https://github.com/riscv/riscv-elf-psabi-doc/blob/master/riscv-elf.md">psABI</a></p>
</div>
</div>

  <div class="section">
  
    


  
  
  </div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
    <a href="https://www.pygears.org">
        <img class="logo" src="../_static/logo.png" alt="Logo"/>
        
    </a>
</p>



<p class="blurb">HW Design: A Functional Approach</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=bogdanvuk&repo=pygears&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>






  
  
  <h2>
  
    
     Draft 
  
  </h2>

  <ul>
    

  
  <li id="author"><span>Author:</span>
    
      
      <a href="../blog/author/bogdan-vukobratovic.html">Bogdan Vukobratović</a>
      
    </li>
  

  

  

  
  <li id="category"><span>Category:</span>
    
      
      <a href="../blog/category/risc-v.html">RISC-V</a>
      
    </li>
  

  
  
  </ul>



  <h3><a href="../blog.html">Recent Posts</a></h3>
  <ul>
    
    
      <li><a href="setup.html">07 October - RISC-V Tools Setup</a></li>
    
      <li><a href="../release/v0.1.1.html">07 October - PyGears 0.1.1 released</a></li>
    
      <li><a href="introduction.html">06 October - RISC-V Blog Series Introduction</a></li>
    
  </ul>

  <h3><a href="../blog/tag.html">Tags</a></h3>
  <style type="text/css">
    ul.ablog-cloud {list-style: none; overflow: auto;}
    ul.ablog-cloud li {float: left; height: 20pt; line-height: 18pt; margin-right: 5px;}
    ul.ablog-cloud a {text-decoration: none; vertical-align: middle;}
    li.ablog-cloud-1{font-size: 80%;}
    li.ablog-cloud-2{font-size: 95%;}
    li.ablog-cloud-3{font-size: 110%;}
    li.ablog-cloud-4{font-size: 125%;}
    li.ablog-cloud-5{font-size: 140%;}
  </style>
  <ul class="ablog-cloud">
    
      
      <li class="ablog-cloud ablog-cloud-3">
        <a href="../blog/tag/setup.html">setup</a></li>
      
    
  </ul>

  <h3><a href="../blog/category.html">Categories</a></h3>
  <ul>
  
    
    <li><a href="../blog/category/risc-v.html">RISC-V (2)</a></li>
    
  
    
    <li><a href="../blog/category/release.html">Release (1)</a></li>
    
  
  </ul>

  <h3><a href="../blog/archive.html">Archives</a></h3>
  <ul>
  
    
    <li><a href="../blog/2018.html">2018 (3)</a></li>
    
  
  </ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Bogdan Vukobratovic.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
      |
      <a href="../_sources/riscv/my_first_instruction.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>