
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>RISC-V Tools Setup &#8212; PyGears</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="RISC-V Blog Series Introduction" href="introduction.html" />
  
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  
  <link rel="alternate" type="application/atom+xml"  href="../blog/atom.xml" title="PyGears">
  
  
  <style type="text/css">
    ul.ablog-archive {list-style: none; overflow: auto; margin-left: 0px}
    ul.ablog-archive li {float: left; margin-right: 5px; font-size: 80%}
    ul.postlist a {font-style: italic;}
    ul.postlist-style-disc {list-style-type: disc;}
    ul.postlist-style-none {list-style-type: none;}
    ul.postlist-style-circle {list-style-type: circle;}
  </style>

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <div class="section" id="risc-v-tools-setup">
<h1>RISC-V Tools Setup<a class="headerlink" href="#risc-v-tools-setup" title="Permalink to this headline">¶</a></h1>

<script>
 function changeVerbosity(verbosity) {

     document.getElementById("verbosity_value").value = verbosity;
     document.getElementById("verbosity_slider").value = verbosity;

     var a = document.querySelectorAll('[data-verbosity]');

     for (var i in a) if (a.hasOwnProperty(i)) {
         if (a[i].getAttribute('data-verbosity') <= verbosity) {
             a[i].removeAttribute("hidden")
         } else {
             a[i].setAttribute("hidden", "true")
         }
     }
 }
</script>

<form class="slidecontainer">
    <b>Slide to adjust verbosity level&ensp;</b>
    <input type="range" min="1" max="2" value="1" name="verbositySlider" id="verbosity_slider" onchange="changeVerbosity(this.value);">
    &ensp;
    <input type="number" maxlength="1" id="verbosity_value" min="1" max="2" value="1" oninput="changeVerbosity(this.value);" style="font-weight: bold"/>
</form>
<p>If I want to approach this project the TDD way, I need to be ready to test the design from the start. Hence, I will start by obtaining the “golden design”, aka “reference model”, aka “test oracle”, depending on the terminology, and setting up the infrastructure to it with PyGears. <span data-verbosity="2" hidden="true"> RISC-V foundation github page offers </span><a class="reference external" data-verbosity="2" hidden="true" href="https://github.com/riscv/riscv-isa-sim/">Spike</a><span data-verbosity="2" hidden="true"> - RISC-V instruction set simulator which implements the RISC-V functional model. There are more simulators listed on the RISC-V </span><a class="reference external" data-verbosity="2" hidden="true" href="https://riscv.org/software-status/">website</a><span data-verbosity="2" hidden="true">, but I’d like to start with the official one. Spike is dependent on some other riscv-tool packages, so I’ll start from </span><a class="reference external" data-verbosity="2" hidden="true" href="https://github.com/riscv/riscv-isa-sim/">riscv-tools</a><span data-verbosity="2" hidden="true"> repo and its setup instructions.</span></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo apt-get install autoconf automake autotools-dev curl libmpc-dev libmpfr-dev libgmp-dev libusb-1.0-0-dev gawk build-essential bison flex texinfo gperf libtool patchutils bc zlib1g-dev device-tree-compiler pkg-config libexpat-dev

<span class="nb">export</span> <span class="nv">RISCV</span><span class="o">=</span>/tools/riscv-tools

git clone https://github.com/riscv/riscv-tools.git <span class="nv">$RISCV</span>/_install
git submodule update --init --recursive
./build.sh

<span class="nb">echo</span> <span class="s2">&quot;&quot;</span> &gt;&gt; /tools/tools.sh
<span class="nb">echo</span> <span class="s2">&quot;# Environment for riscv-tools&quot;</span> &gt;&gt; /tools/tools.sh
<span class="nb">echo</span> <span class="s2">&quot;export RISCV=/tools/riscv-tools&quot;</span> &gt;&gt; /tools/tools.sh
<span class="nb">echo</span> <span class="s2">&quot;export PATH=\$RISCV/bin:\$PATH&quot;</span> &gt;&gt; /tools/tools.sh
<span class="nb">source</span> /tools/tools.sh
</pre></div>
</div>
<p><span data-verbosity="2" hidden="true"> This took a while on my laptop, since whole RISC-V GCC compiler toolchain is being downloaded and built. </span><span> Finally, lets try if I can simulate a simple program. </span><span data-verbosity="2" hidden="true"> Unfortunatelly, the example given on the riscv-tools github page is for compiling C code. Since I’m interested in testing individual instructions, compiling from C will make too many hoops in the process. I need to be able to directly specify inftructions in assembly and avoid as much boilerplate as possible, i.e. main function call and stack manipulation. I started with the instructions provided in </span><a class="reference external" data-verbosity="2" hidden="true" href="https://github.com/jonesinator/riscv-spike-minimal-assembly/">riscv-spike-minimal-assembly github repo</a><span data-verbosity="2" hidden="true">. </span><span> I ended up with the following simple linker script </span><code class="docutils literal notranslate"><span class="pre">bare.ld</span></code><span>:</span></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SECTIONS</span>
<span class="p">{</span>
<span class="o">.</span> <span class="o">=</span> <span class="mh">0x80000000</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><span data-verbosity="2" hidden="true"> Why am I placing my code at address </span><code class="docutils literal notranslate" data-verbosity="2" hidden="true"><span class="pre">0x80000000</span></code><span data-verbosity="2" hidden="true">? Because nothing else worked. My best guess is that simulator maps RAM at address </span><code class="docutils literal notranslate" data-verbosity="2" hidden="true"><span class="pre">0x80000000</span></code><span data-verbosity="2" hidden="true"> by default and gets angry if you want your code somewhere else. </span><span> I created a proof of concept assembly file </span><code class="docutils literal notranslate"><span class="pre">hello.s</span></code><span>. </span><span data-verbosity="2" hidden="true"> It contains the example instruction that I want to test </span><code class="docutils literal notranslate" data-verbosity="2" hidden="true"><span class="pre">li</span> <span class="pre">a1,</span> <span class="pre">1</span></code><span data-verbosity="2" hidden="true"> and some boilerplate needed to play nicely with the Spike simulator:</span></p>
<div class="highlight-ca65 notranslate"><div class="highlight"><pre><span></span><span class="c1">;; # Very simple assembly program that will cause Spike to terminate gracefully.</span>

<span class="kp">.text</span>
  <span class="kp">.global</span> <span class="n">_start</span>

<span class="nl">_start:</span>

  <span class="c1">;; # The actual instruction I&#39;d like to test.</span>
<span class="hll">  <span class="n">li</span> <span class="n">a1</span><span class="p">,</span> <span class="mi">1</span>
</span>
  <span class="c1">;; # Write the value 1 to tohost, telling Spike to quit with an exit code of 0.</span>
  <span class="n">li</span> <span class="n">t0</span><span class="p">,</span> <span class="mi">1</span>
  <span class="n">la</span> <span class="n">t1</span><span class="p">,</span> <span class="n">tohost</span>
  <span class="n">sw</span> <span class="n">t0</span><span class="p">,</span> <span class="mi">0</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>

  <span class="c1">;; # Spin until Spike terminates the simulation.</span>
  <span class="mi">1</span><span class="p">:</span> <span class="n">j</span> <span class="mi">1</span><span class="n">b</span>

<span class="c1">;; # Expose tohost and fromhost to Spike so we can communicate with it.</span>
<span class="kp">.data</span>
  <span class="kp">.global</span> <span class="n">tohost</span>
<span class="nl">tohost:</span>   <span class="kp">.dword</span> <span class="mi">0</span>
  <span class="kp">.global</span> <span class="n">fromhost</span>
<span class="nl">fromhost:</span> <span class="kp">.dword</span> <span class="mi">0</span>
</pre></div>
</div>
<p><span data-verbosity="2" hidden="true"> I learned </span><a class="reference external" data-verbosity="2" hidden="true" href="https://gnu-mcu-eclipse.github.io/toolchain/riscv/">here</a><span data-verbosity="2" hidden="true"> how to tell the compiler which version of the RISC-V ISA to use. Since I’m starting the hardware implementation from scratch, I’m interested in most basic 32-bit ISA version, hence I need to call GCC with </span><code class="docutils literal notranslate" data-verbosity="2" hidden="true"><span class="pre">-march=rv32i</span> <span class="pre">-mabi=ilp32</span></code><span data-verbosity="2" hidden="true">. Next, in order to have the code without </span><code class="docutils literal notranslate" data-verbosity="2" hidden="true"><span class="pre">main()</span></code><span data-verbosity="2" hidden="true">, you need to provide the </span><code class="docutils literal notranslate" data-verbosity="2" hidden="true"><span class="pre">-nostdlib</span></code><span data-verbosity="2" hidden="true"> flag too, which was hinted in the answer to </span><a class="reference external" data-verbosity="2" hidden="true" href="https://stackoverflow.com/questions/31390127/how-can-i-compile-c-code-to-get-a-bare-metal-skeleton-of-a-minimal-risc-v-assemb">this stackoverflow question</a><span data-verbosity="2" hidden="true">. </span><span> I ended up with the following command to call GCC:</span></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>riscv64-unknown-elf-gcc -march<span class="o">=</span>rv32i -mabi<span class="o">=</span>ilp32 -nostdlib -T bare.ld hello.s -o hello
</pre></div>
</div>
<p data-verbosity="2" hidden="true">Execution of this command leaves me with the <code class="docutils literal notranslate"><span class="pre">hello</span></code> elf file in the same directory. In order to see the machine code of the instructions and their places in memory, I can run the dissasembler:</p>
<div hidden data-verbosity=2>
<div class="highlight-bash notranslate" data-verbosity="2" hidden="true"><div class="highlight"><pre><span></span>riscv64-unknown-elf-objdump -d hello
</pre></div>
</div>

</div><p data-verbosity="2" hidden="true">which gives me the following output:</p>
<div hidden data-verbosity=2>
<div class="highlight-objdump notranslate" data-verbosity="2" hidden="true"><div class="highlight"><pre><span></span><span class="nl"> hello</span><span class="p">:</span>     file format <span class="s">elf32-littleriscv</span>


<span class="x"> Disassembly of section .text:</span>

<span class="x"> 80000000 &lt;_start&gt;:</span>
<span class="hll"><span class="x"> 80000000:   00100593                li      a1,1</span>
</span><span class="x"> 80000004:   00100293                li      t0,1</span>
<span class="x"> 80000008:   00000317                auipc   t1,0x0</span>
<span class="x"> 8000000c:   01030313                addi    t1,t1,16 # 80000018 &lt;tohost&gt;</span>
<span class="x"> 80000010:   00532023                sw      t0,0(t1)</span>
<span class="x"> 80000014:   0000006f                j       80000014 &lt;_start+0x14&gt;</span>
</pre></div>
</div>

</div><p><span data-verbosity="2" hidden="true">Sucess! The target test instruction is first to be executed, which will simplify my tests. </span><span> I can now invoke Spike simulator for the basic 32-bit ISA (</span><code class="docutils literal notranslate"><span class="pre">--isa=rv32i</span></code><span> option) to test the instruction execution and print the list of the instructions it their execution order (</span><code class="docutils literal notranslate"><span class="pre">-l</span></code><span> option):</span></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>spike -l --isa<span class="o">=</span>rv32i hello
</pre></div>
</div>
<p><span>Command produces output given below. </span><span data-verbosity="2" hidden="true"> Log shows that the simulator inserted 5 additional instructions at address </span><code class="docutils literal notranslate" data-verbosity="2" hidden="true"><span class="pre">0x1000</span></code><span data-verbosity="2" hidden="true">, which I guess is the fixed position where the execution starts. Last of these five jumps to my example test instruction, now at address </span><code class="docutils literal notranslate" data-verbosity="2" hidden="true"><span class="pre">0xffffffff80000000</span></code><span data-verbosity="2" hidden="true">? Sign extension I guess?</span></p>
<div class="highlight-objdump notranslate"><div class="highlight"><pre><span></span><span class="x"> core   0: 0x0000000000001000 (0x00000297) auipc   t0, 0x0</span>
<span class="x"> core   0: 0x0000000000001004 (0x02028593) addi    a1, t0, 32</span>
<span class="x"> core   0: 0x0000000000001008 (0xf1402573) csrr    a0, mhartid</span>
<span class="x"> core   0: 0x000000000000100c (0x0182a283) lw      t0, 24(t0)</span>
<span class="x"> core   0: 0x0000000000001010 (0x00028067) jr      t0</span>
<span class="hll"><span class="x"> core   0: 0xffffffff80000000 (0x00100593) li      a1, 1</span>
</span><span class="x"> core   0: 0xffffffff80000004 (0x00100293) li      t0, 1</span>
<span class="x"> core   0: 0xffffffff80000008 (0x00000317) auipc   t1, 0x0</span>
<span class="x"> core   0: 0xffffffff8000000c (0x01030313) addi    t1, t1, 16</span>
<span class="x"> core   0: 0xffffffff80000010 (0x00532023) sw      t0, 0(t1)</span>
<span class="x"> core   0: 0xffffffff80000014 (0x0000006f) j       pc + 0x0</span>
</pre></div>
</div>
<p data-verbosity="2" hidden="true">It doesn’t matter anyways because it worked! I’ll probably get more insight into Spike as the time passes and figure exactly what’s happening, but it’s enough for the start. I invoked the simulator in interactive debug mode in order to check how the test instruction alters the processor state. The instruction <code class="docutils literal notranslate"><span class="pre">li</span> <span class="pre">a1,</span> <span class="pre">1</span></code> should load a value of 1 to the register <code class="docutils literal notranslate"><span class="pre">a1</span></code>. Name <code class="docutils literal notranslate"><span class="pre">li</span></code> stands for “load immediate” since it loads to a register a value that is immediatelly available in the instruction code. The code of this instruction is <code class="docutils literal notranslate"><span class="pre">0x00100593</span></code>, and there it is, the value of 1 in top three nibbles of the code: <code class="docutils literal notranslate"><span class="pre">0x001</span></code>.</p>
<div hidden data-verbosity=2>
<div class="highlight-bash notranslate" data-verbosity="2" hidden="true"><div class="highlight"><pre><span></span>spike -d --isa<span class="o">=</span>rv32i hello
</pre></div>
</div>

</div><p data-verbosity="2" hidden="true">I issued the following commands in order to test the value of the register <code class="docutils literal notranslate"><span class="pre">a1</span></code> before and after the test instruction execution to observe the instruction effect. This is exactly what I will do when I start hardware implementation, in order to test it against the reference design which is the Spike simulator.</p>
<div hidden data-verbosity=2>
<div class="highlight-bash notranslate" data-verbosity="2" hidden="true"><div class="highlight"><pre><span></span>: <span class="k">until</span> pc <span class="m">0</span> 0xffffffff80000000
: reg <span class="m">0</span> a1
0x0000000000001020
: <span class="k">until</span> pc <span class="m">0</span> 0xffffffff80000004
: reg <span class="m">0</span> a1
0x0000000000000001
: q
</pre></div>
</div>

</div></div>

  <div class="section">
  
    


<div class="section">
  <span style="float: left;">
  
  </span>
  <span>&nbsp;</span>
  <span style="float: right;">
  
</div>

  
  
    <div class="section">
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'pygears';
        var disqus_identifier = '/riscv/setup/';
        var disqus_title = 'RISC-V Tools Setup';
        var disqus_url = 'https://bogdanvuk.github.io/pygears/riscv/setup';

        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  
  </div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">PyGears</a></h1>



<p class="blurb">PyGears blog</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=bogdanvuk&repo=pygears&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a href="https://travis-ci.org/bogdanvuk/pygears">
    <img
        alt="https://secure.travis-ci.org/bogdanvuk/pygears.svg?branch=master"
        src="https://secure.travis-ci.org/bogdanvuk/pygears.svg?branch=master"
    />
</a>
</p>



  
  
  <h2>
  
  
    20 September 2018
  
  </h2>

  <ul>
    

  
  <li id="author"><span>Author:</span>
    
      
      <a href="../blog/author/bogdan-vukobratovic.html">Bogdan Vukobratović</a>
      
    </li>
  

  

  
  <li id="language"><span>Language:</span>
    
      
      <a href="../blog/language/english.html">English</a>
      
    </li>
  

  
  <li id="category"><span>Category:</span>
    
      
      <a href="../blog/category/risc-v.html">RISC-V</a>
      
    </li>
  

  
  <li id="tags"><span>Tags:</span>
      
    
      
      <a href="../blog/tag/riscv.html">riscv</a>
      
    
      
      <a href="../blog/tag/setup.html">setup</a>
      
    </li>
  
  
  <li id="comments">
    <script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'pygears'; // required: replace example with your forum shortname

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
    var s = document.createElement('script'); s.async = true;
    s.type = 'text/javascript';
    s.src = '//' + disqus_shortname + '.disqus.com/count.js';
    (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
    </script>
    
    <a href="#disqus_thread" data-disqus-identifier="/riscv/setup/"> Comments</a>
  </li>
  
  </ul>



  <h3><a href="../blog.html">Recent Posts</a></h3>
  <ul>
    
    
  </ul>

  <h3><a href="../blog/tag.html">Tags</a></h3>
  <style type="text/css">
    ul.ablog-cloud {list-style: none; overflow: auto;}
    ul.ablog-cloud li {float: left; height: 20pt; line-height: 18pt; margin-right: 5px;}
    ul.ablog-cloud a {text-decoration: none; vertical-align: middle;}
    li.ablog-cloud-1{font-size: 80%;}
    li.ablog-cloud-2{font-size: 95%;}
    li.ablog-cloud-3{font-size: 110%;}
    li.ablog-cloud-4{font-size: 125%;}
    li.ablog-cloud-5{font-size: 140%;}
  </style>
  <ul class="ablog-cloud">
    
      
      <li class="ablog-cloud ablog-cloud-3">
        <a href="../blog/tag/riscv.html">riscv</a></li>
      
    
      
      <li class="ablog-cloud ablog-cloud-3">
        <a href="../blog/tag/setup.html">setup</a></li>
      
    
  </ul>

  <h3><a href="../blog/category.html">Categories</a></h3>
  <ul>
  
    
    <li><a href="../blog/category/risc-v.html">RISC-V (1)</a></li>
    
  
    
  
  </ul>

  <h3><a href="../blog/archive.html">Archives</a></h3>
  <ul>
  
    
    <li><a href="../blog/2018.html">2018 (1)</a></li>
    
  
  </ul>

<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Bogdan Vukobratović.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.8.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.11</a>
      
      |
      <a href="../_sources/riscv/setup.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>